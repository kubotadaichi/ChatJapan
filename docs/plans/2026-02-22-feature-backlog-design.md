# ChatJapan 機能バックログ 設計ドキュメント

**作成日:** 2026-02-22
**ステータス:** 承認済み

---

## 概要

今後実装予定の機能を優先度・性質別に整理した優先度付きバックログ。
「すぐ着手できるもの（Quick Wins）」「本格機能（Features）」「研究フェーズ（Research）」の3トラックで管理する。

AWS移行は既存設計ドキュメント（`2026-02-21-chatjapan-design.md` Phase 7）で別管理。

---

## Quick Wins トラック

1〜2時間以内で完了できる小タスク。まず実績を積むために先行して実施する。

| ID | タスク | 対象ファイル | 概要 |
|----|--------|------------|------|
| Q1 | Cmd/Ctrl+Enter 送信 | `ChatInput.tsx` | `onKeyDown` で `metaKey/ctrlKey + Enter` を検知し送信 |
| Q2 | ファビコン変更 | `public/`, `app/layout.tsx` | 日本地図・地域アイコン系のfaviconに差し替え |
| Q3 | ログイン表示をアイコンに | `Header.tsx` | ログイン中: email文字列 → アバター画像 + ドロップダウンメニュー |

---

## Features トラック

中期（数ヶ月以内）に実装する本格機能。依存関係を考慮した順序で記載。

| ID | タスク | 依存 | 概要 |
|----|--------|------|------|
| F1 | マークダウンレンダリング | — | `MessageList` に `react-markdown` + `remark-gfm` 導入。AIの回答を構造化表示 |
| F2 | 回答フィードバック（👍👎コピー） | — | メッセージのアクションバー追加。👍/👎ボタンとコピーボタンを表示 |
| F3 | システムプロンプト規定 | — | `src/app/api/chat/route.ts` に詳細なシステムプロンプトを整備。LLMの挙動・出力フォーマットを安定化 |
| F4 | 自然会話でエリア追加 | F3 | `addArea(name, code)` ツールをLLMに定義。チャットでエリア指定ができるように |
| F5 | 複数地点選択 | — | `SelectedArea` を配列化。地図で複数ハイライト、チャットに複数エリアのコンテキストを渡す |
| F6 | 初利用時ガイダンス | — | `localStorage` でフラグ管理。初回アクセス時にオンボーディングUIを表示 |
| F7 | 特化エージェント（マーケティング担当） | F3, F5 | エージェントモード選択UI + 商圏分析に特化したシステムプロンプト |
| F8 | 特化エージェント（スライド作成） | F7 | Marp形式のMarkdown出力ツール追加。スライド生成エージェントモード |

### 各タスクの詳細

#### F1: マークダウンレンダリング
- `react-markdown` + `remark-gfm` をインストール
- `MessageList.tsx` のAIメッセージ部分のみに適用（ユーザーメッセージはプレーンテキストのまま）
- テーブル・コードブロック・箇条書きが正しくレンダリングされることを確認

#### F2: 回答フィードバック
- メッセージホバー時にアクションバーを表示（モバイルは常時表示）
- 👍/👎はローカル状態管理（将来的にDB保存を検討）
- コピーボタンは `navigator.clipboard.writeText()` でプレーンテキストコピー

#### F3: システムプロンプト規定
- AIの役割・出力フォーマット（マークダウン使用など）・統計データの引用ルールを定義
- 日本語で回答すること、根拠を明示することなどの基本方針を記述
- F4（自然会話エリア追加）の前提として必要

#### F4: 自然会話でエリア追加
- `addArea(name: string, code: string, level: "prefecture"|"municipality")` ツールを定義
- LLMが地名を認識したとき自動的にエリアをセットできる
- フロントエンドで `tool-call` メッセージを受け取ってMapPanelに反映する仕組みが必要

#### F5: 複数地点選択
- `SelectedArea | null` → `SelectedArea[]` に型変更
- 地図: 複数エリアのハイライト対応
- チャット入力: 複数エリアのチップ表示
- LLMへのコンテキスト: 複数エリアの統計データを並列フェッチして渡す

#### F6: 初利用時ガイダンス
- `localStorage.getItem('guided')` で初回判定
- モーダルまたはオーバーレイで操作方法を案内
- 「地図でエリアを選択 → 質問する」の基本フローを説明

#### F7/F8: 特化エージェント
- モード選択UI（デフォルト / マーケティング / スライド作成）
- モードごとに異なるシステムプロンプトを切り替える
- スライド作成エージェント: Marp形式（`---` 区切り）でMarkdownを出力し、コードブロックで表示

---

## Research トラック

研究・実験フェーズのタスク。実装タスクとは分離して管理する。

| ID | タスク | 概要 |
|----|--------|------|
| R1 | カテゴリ選択ロジックの強化 | ユーザーの質問から適切な統計カテゴリをLLMに自動選択させる仕組みの研究・実験。`listStatisticsCategories()` ツールの活用方法を含む |

### R1 研究ノート（初期メモ）
- 現在の `categories.ts` はカテゴリIDを固定マッピングしている
- 質問の意図を理解して適切なカテゴリを選ぶには、LLMへのカテゴリ説明文の設計が鍵
- 評価指標: 適切なカテゴリが選ばれる割合、不要なAPIコールの削減
- 既存設計 `2026-02-21-statistics-category-expansion-design.md` も参照

---

## 実装推奨順序

```
Quick Wins: Q1 → Q2 → Q3 （並列可能、1〜2日で完了）
     ↓
Features:   F1 → F2 → F3 → F5 → F4 → F6 → F7 → F8
              （F1/F2/F3/F5 は並列可能）
              （F4 は F3 完了後）
              （F7 は F3+F5 完了後）
              （F8 は F7 完了後）

Research:   R1 （独立して進行可能）
```
